<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>🚀 Building a Kubernetes Operator with an NGINX CRD | Kubermates</title><meta name=description content="Kubernetes is a powerful platform that automates the deployment, scaling, and management of..."><meta property="og:url" content="https://kubermates.org/blog/building-a-kubernetes-operator-with-an-nginx-crd-3lil/"><meta property="og:site_name" content="Kubermates"><meta property="og:title" content="🚀 Building a Kubernetes Operator with an NGINX CRD"><meta property="og:description" content="Kubernetes is a powerful platform that automates the deployment, scaling, and management of..."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-08-29T08:25:36+00:00"><meta property="article:modified_time" content="2024-08-29T08:25:36+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Cloud"><meta property="article:tag" content="Containers"><meta property="article:tag" content="Opensource"><meta itemprop=name content="🚀 Building a Kubernetes Operator with an NGINX CRD"><meta itemprop=description content="Kubernetes is a powerful platform that automates the deployment, scaling, and management of..."><meta itemprop=datePublished content="2024-08-29T08:25:36+00:00"><meta itemprop=dateModified content="2024-08-29T08:25:36+00:00"><meta itemprop=wordCount content="1443"><meta itemprop=keywords content="Kubernetes,Cloud,Containers,Opensource"><meta name=twitter:card content="summary"><meta name=twitter:title content="🚀 Building a Kubernetes Operator with an NGINX CRD"><meta name=twitter:description content="Kubernetes is a powerful platform that automates the deployment, scaling, and management of..."><link rel=preload href=/scss/main.min.f21cdd215205aa393cb73e4e99d80ac2f637aa8b405381de7006586191c98d17.css as=style integrity="sha256-8hzdIVIFqjk8tz5OmdgKwvY3qotAU4HecAZYYZHJjRc=" crossorigin=anonymous><link href=/scss/main.min.f21cdd215205aa393cb73e4e99d80ac2f637aa8b405381de7006586191c98d17.css rel=stylesheet integrity="sha256-8hzdIVIFqjk8tz5OmdgKwvY3qotAU4HecAZYYZHJjRc=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=theme-color content="#00D1B2"></head><body class="td-page td-blog"><header><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><div class=container-fluid><a class=navbar-brand href=https://kubermates.org/><img src=/images/nav-logo-white.png srcset="/images/nav-logo-white.png 1x, /images/nav-logo-white@2x.png 2x" alt=Kubermates width=auto height=48>
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><a class=nav-link href=/blog/>Articles</a></li><li class=nav-item><a class=nav-link href=/events/>Events</a></li><li class=nav-item><a class=nav-link href=/docs/>Docs</a></li><li class=nav-item><a class=nav-link href=/releases/>Releases</a></li><li class=nav-item><a class=nav-link href=/contribute/>Contribute</a></li></ul></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blogs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogfirst-post-li><a href=/blog/first-post/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogfirst-post><span>launching kubermates</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloggithub-actions-composite-vs-reusable-workflows-4bih-li><a href=/blog/github-actions-composite-vs-reusable-workflows-4bih/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloggithub-actions-composite-vs-reusable-workflows-4bih><span>🧩 GitHub Actions Composite vs Reusable Workflows</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogelevating-infrastructure-from-terraformterragrunt-foundations-to-platform-engineering-41fc-li><a href=/blog/elevating-infrastructure-from-terraformterragrunt-foundations-to-platform-engineering-41fc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogelevating-infrastructure-from-terraformterragrunt-foundations-to-platform-engineering-41fc><span>🚀🌐 Elevating Infrastructure: From Terraform/Terragrunt Foundations to Platform Engineering 😊</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogsecure-secret-management-with-sops-in-helm-1940-li><a href=/blog/secure-secret-management-with-sops-in-helm-1940/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogsecure-secret-management-with-sops-in-helm-1940><span>🔐 Secure Secret Management with SOPS in Helm 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogsecure-secret-management-with-sops-in-terraform-terragrunt-231a-li><a href=/blog/secure-secret-management-with-sops-in-terraform-terragrunt-231a/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogsecure-secret-management-with-sops-in-terraform-terragrunt-231a><span>🔐 Secure Secret Management with SOPS in Terraform & Terragrunt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloghelm-chart-essentials-writing-effective-charts-11ca-li><a href=/blog/helm-chart-essentials-writing-effective-charts-11ca/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloghelm-chart-essentials-writing-effective-charts-11ca><span>Helm Chart Essentials & Writing Effective Charts 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogunlocking-secrets-with-external-secrets-operator-2f89-li><a href=/blog/unlocking-secrets-with-external-secrets-operator-2f89/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogunlocking-secrets-with-external-secrets-operator-2f89><span>Unlocking Secrets with External Secrets Operator 🔐✨</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogautomating-dns-in-azure-private-dns-with-external-dns-3knk-li><a href=/blog/automating-dns-in-azure-private-dns-with-external-dns-3knk/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogautomating-dns-in-azure-private-dns-with-external-dns-3knk><span>Automating DNS in Azure Private DNS with External-DNS ☁️🔐</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogusing-nginx-ingress-controller-and-cert-manager-for-https-with-lets-encrypt-2flh-li><a href=/blog/using-nginx-ingress-controller-and-cert-manager-for-https-with-lets-encrypt-2flh/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogusing-nginx-ingress-controller-and-cert-manager-for-https-with-lets-encrypt-2flh><span>Using Nginx Ingress Controller and Cert-Manager for HTTPS with Let’s Encrypt ⚡</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogensuring-effective-helm-charts-with-linting-testing-and-diff-checks-ni0-li><a href=/blog/ensuring-effective-helm-charts-with-linting-testing-and-diff-checks-ni0/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogensuring-effective-helm-charts-with-linting-testing-and-diff-checks-ni0><span>Ensuring Effective Helm Charts with Linting, Testing, and Diff Checks 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogcapsule-how-to-use-it-and-first-steps-to-set-it-up-on-an-aks-cluster-5hl5-li><a href=/blog/capsule-how-to-use-it-and-first-steps-to-set-it-up-on-an-aks-cluster-5hl5/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogcapsule-how-to-use-it-and-first-steps-to-set-it-up-on-an-aks-cluster-5hl5><span>Capsule: How to Use It and First Steps to Set It Up on an AKS Cluster 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogunderstanding-aks-nap-azure-kubernetes-service-node-auto-provisioning-powered-by-karpenter-3djh-li><a href=/blog/understanding-aks-nap-azure-kubernetes-service-node-auto-provisioning-powered-by-karpenter-3djh/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogunderstanding-aks-nap-azure-kubernetes-service-node-auto-provisioning-powered-by-karpenter-3djh><span>Understanding AKS NAP: Azure Kubernetes Service Node Auto-Provisioning (Powered by Karpenter) 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogadmission-controllers-in-kubernetes-opa-gatekeeper-kyverno-and-azure-policy-add-on-for-aks-which-one-wins-237d-li><a href=/blog/admission-controllers-in-kubernetes-opa-gatekeeper-kyverno-and-azure-policy-add-on-for-aks-which-one-wins-237d/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogadmission-controllers-in-kubernetes-opa-gatekeeper-kyverno-and-azure-policy-add-on-for-aks-which-one-wins-237d><span>Admission Controllers in Kubernetes: OPA GateKeeper, Kyverno, and Azure Policy Add-on for AKS—Which One Wins? 🏆</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogupgrading-aks-in-place-blue-green-and-canary-upgrades-explained-3aap-li><a href=/blog/upgrading-aks-in-place-blue-green-and-canary-upgrades-explained-3aap/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogupgrading-aks-in-place-blue-green-and-canary-upgrades-explained-3aap><span>Upgrading AKS: In-Place, Blue-Green, and Canary Upgrades Explained 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogmonitor-and-optimize-multi-cluster-aks-costs-4627-li><a href=/blog/monitor-and-optimize-multi-cluster-aks-costs-4627/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogmonitor-and-optimize-multi-cluster-aks-costs-4627><span>Monitor and Optimize Multi-Cluster AKS Costs 💰</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogenhancing-container-security-the-complete-guide-to-secure-and-clean-kubernetes-clusters-1ida-li><a href=/blog/enhancing-container-security-the-complete-guide-to-secure-and-clean-kubernetes-clusters-1ida/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogenhancing-container-security-the-complete-guide-to-secure-and-clean-kubernetes-clusters-1ida><span>🚀 Enhancing Container Security: The Complete Guide to Secure and Clean Kubernetes Clusters 🛡️🧼</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogkarmada-deep-dive-into-managing-multiple-aks-clusters-1j08-li><a href=/blog/karmada-deep-dive-into-managing-multiple-aks-clusters-1j08/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogkarmada-deep-dive-into-managing-multiple-aks-clusters-1j08><span>Karmada: Deep Dive into Managing Multiple AKS Clusters 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogunderstanding-ebpf-and-its-application-in-modern-cloud-environments-3f99-li><a href=/blog/understanding-ebpf-and-its-application-in-modern-cloud-environments-3f99/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogunderstanding-ebpf-and-its-application-in-modern-cloud-environments-3f99><span>Understanding eBPF and Its Application in Modern Cloud Environments 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogsecuring-kubernetes-secrets-in-aks-using-azure-key-vault-with-managed-and-user-assigned-identities-569k-li><a href=/blog/securing-kubernetes-secrets-in-aks-using-azure-key-vault-with-managed-and-user-assigned-identities-569k/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogsecuring-kubernetes-secrets-in-aks-using-azure-key-vault-with-managed-and-user-assigned-identities-569k><span>🌐 Securing Kubernetes Secrets in AKS: Using Azure Key Vault with Managed and User Assigned Identities 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogautomating-image-vulnerability-patching-in-kubernetes-with-trivy-operator-copacetic-and-github-actions-13l-li><a href=/blog/automating-image-vulnerability-patching-in-kubernetes-with-trivy-operator-copacetic-and-github-actions-13l/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogautomating-image-vulnerability-patching-in-kubernetes-with-trivy-operator-copacetic-and-github-actions-13l><span>🚀 Automating Image Vulnerability Patching in Kubernetes with Trivy Operator, Copacetic, and GitHub Actions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogautoscaling-in-kubernetes-keda-karpenter-and-native-autoscalers-1gpo-li><a href=/blog/autoscaling-in-kubernetes-keda-karpenter-and-native-autoscalers-1gpo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogautoscaling-in-kubernetes-keda-karpenter-and-native-autoscalers-1gpo><span>Autoscaling in Kubernetes: KEDA, Karpenter, and Native Autoscalers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloginsights-on-securing-your-kubernetes-cluster-with-falco-4b9g-li><a href=/blog/insights-on-securing-your-kubernetes-cluster-with-falco-4b9g/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloginsights-on-securing-your-kubernetes-cluster-with-falco-4b9g><span>Insights on Securing Your Kubernetes Cluster with Falco 🚀🔒</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blogbuilding-a-kubernetes-operator-with-an-nginx-crd-3lil-li><a href=/blog/building-a-kubernetes-operator-with-an-nginx-crd-3lil/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-blogbuilding-a-kubernetes-operator-with-an-nginx-crd-3lil><span class=td-sidebar-nav-active-item>🚀 Building a Kubernetes Operator with an NGINX CRD</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloghacking-the-helm-operator-with-flux-creating-self-installable-services-for-easier-app-deployment-5a8l-li><a href=/blog/hacking-the-helm-operator-with-flux-creating-self-installable-services-for-easier-app-deployment-5a8l/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloghacking-the-helm-operator-with-flux-creating-self-installable-services-for-easier-app-deployment-5a8l><span>🎨 Hacking the Helm Operator with Flux: Creating Self-Installable Services for Easier App Deployment</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogchaos-engineering-lets-break-everything-io0-li><a href=/blog/chaos-engineering-lets-break-everything-io0/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogchaos-engineering-lets-break-everything-io0><span>Chaos Engineering Let's Break Everything! 😈</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloga-guide-to-modern-kubernetes-service-networking-4017-li><a href=/blog/a-guide-to-modern-kubernetes-service-networking-4017/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloga-guide-to-modern-kubernetes-service-networking-4017><span>A Guide to Modern Kubernetes Service Networking 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogeffective-vulnerability-monitoring-in-kubernetes-1mge-li><a href=/blog/effective-vulnerability-monitoring-in-kubernetes-1mge/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogeffective-vulnerability-monitoring-in-kubernetes-1mge><span>🛡️ Effective Vulnerability Monitoring in Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogkubernetes-multi-cluster-management-1nek-li><a href=/blog/kubernetes-multi-cluster-management-1nek/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogkubernetes-multi-cluster-management-1nek><span>Kubernetes Multi-Cluster Management 📦</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloghow-to-make-your-docker-images-go-on-a-diet-88l-li><a href=/blog/how-to-make-your-docker-images-go-on-a-diet-88l/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloghow-to-make-your-docker-images-go-on-a-diet-88l><span>How to Make Your Docker Images Go on a Diet 🏊‍♂️</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloga-quick-navigation-through-service-mesh-in-kubernetes-5dea-li><a href=/blog/a-quick-navigation-through-service-mesh-in-kubernetes-5dea/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloga-quick-navigation-through-service-mesh-in-kubernetes-5dea><span>A quick navigation through Service Mesh in Kubernetes 👀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogkubernetes-rbac-and-role-aggregation-made-easy-3j4o-li><a href=/blog/kubernetes-rbac-and-role-aggregation-made-easy-3j4o/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogkubernetes-rbac-and-role-aggregation-made-easy-3j4o><span>🚀 Kubernetes RBAC and Role Aggregation Made Easy</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogessential-tips-for-setting-resource-limits-in-kubernetes-3b54-li><a href=/blog/essential-tips-for-setting-resource-limits-in-kubernetes-3b54/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogessential-tips-for-setting-resource-limits-in-kubernetes-3b54><span>Essential Tips for Setting Resource Limits in Kubernetes 📈</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogkubernetes-dns-how-to-use-in-cluster-and-azure-private-dns-together-48h3-li><a href=/blog/kubernetes-dns-how-to-use-in-cluster-and-azure-private-dns-together-48h3/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogkubernetes-dns-how-to-use-in-cluster-and-azure-private-dns-together-48h3><span>🌐 Kubernetes DNS: How to Use In-Cluster and Azure Private DNS Together</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloghow-to-manage-kubernetes-app-storage-like-a-pro-o33-li><a href=/blog/how-to-manage-kubernetes-app-storage-like-a-pro-o33/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloghow-to-manage-kubernetes-app-storage-like-a-pro-o33><span>How to Manage Kubernetes App Storage Like a Pro 📁</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blogunderstanding-pod-topology-spread-constraints-and-node-affinity-in-kubernetes-49a2-li><a href=/blog/understanding-pod-topology-spread-constraints-and-node-affinity-in-kubernetes-49a2/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blogunderstanding-pod-topology-spread-constraints-and-node-affinity-in-kubernetes-49a2><span>Understanding Pod Topology Spread Constraints and Node Affinity in Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloghow-to-test-the-latest-kubernetes-changes-in-version-131-elli-39ec-li><a href=/blog/how-to-test-the-latest-kubernetes-changes-in-version-131-elli-39ec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-bloghow-to-test-the-latest-kubernetes-changes-in-version-131-elli-39ec><span>How to Test the Latest Kubernetes Changes in Version 1.31 "Elli"</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubermates-org/kubermates-site/tree/main/content/blog/2024-08-29-building-a-kubernetes-operator-with-an-nginx-crd-3lil.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/kubermates-org/kubermates-site/edit/main/content/blog/2024-08-29-building-a-kubernetes-operator-with-an-nginx-crd-3lil.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/kubermates-org/kubermates-site/new/main/content/blog?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/kubermates-org/kubermates-site/issues/new?title=%f0%9f%9a%80%20Building%20a%20Kubernetes%20Operator%20with%20an%20NGINX%20CRD" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#-understanding-kubernetes-controllers-operators-and-crds>🤖 Understanding Kubernetes Controllers, Operators, and CRDs</a></li><li><a href=#-core-components-manager-scheme-and-kinds>🛠️ Core Components: Manager, Scheme, and Kinds</a></li><li><a href=#-a-simple-nginx-operator-example>🧑‍💻 A Simple NGINX Operator Example</a></li><li><a href=#-object-lifecycle-and-garbage-collection>🔄 Object Lifecycle and Garbage Collection</a></li><li><a href=#-building-and-deploying-the-operator>🚢 Building and Deploying the Operator</a></li><li><a href=#-creating-an-nginx-custom-resource>🧑‍🏭 Creating an Nginx Custom Resource</a></li><li><a href=#-conclusion>🎉 Conclusion</a></li></ul></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tags</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://kubermates.org/tags/announcement/ data-taxonomy-term=announcement><span class=taxonomy-label>Announcement</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/automation/ data-taxonomy-term=automation><span class=taxonomy-label>Automation</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/aws/ data-taxonomy-term=aws><span class=taxonomy-label>Aws</span><span class=taxonomy-count>12</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/azure/ data-taxonomy-term=azure><span class=taxonomy-label>Azure</span><span class=taxonomy-count>13</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cicd/ data-taxonomy-term=cicd><span class=taxonomy-label>Cicd</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cloud/ data-taxonomy-term=cloud><span class=taxonomy-label>Cloud</span><span class=taxonomy-count>28</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cloud-foundation/ data-taxonomy-term=cloud-foundation><span class=taxonomy-label>Cloud-Foundation</span><span class=taxonomy-count>16</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cloudnative/ data-taxonomy-term=cloudnative><span class=taxonomy-label>Cloudnative</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cncf/ data-taxonomy-term=cncf><span class=taxonomy-label>Cncf</span><span class=taxonomy-count>72</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/community/ data-taxonomy-term=community><span class=taxonomy-label>Community</span><span class=taxonomy-count>51</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/containers/ data-taxonomy-term=containers><span class=taxonomy-label>Containers</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/devops/ data-taxonomy-term=devops><span class=taxonomy-label>Devops</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/docker/ data-taxonomy-term=docker><span class=taxonomy-label>Docker</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/eks/ data-taxonomy-term=eks><span class=taxonomy-label>Eks</span><span class=taxonomy-count>41</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/event/ data-taxonomy-term=event><span class=taxonomy-label>Event</span><span class=taxonomy-count>65</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/falco/ data-taxonomy-term=falco><span class=taxonomy-label>Falco</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/finops/ data-taxonomy-term=finops><span class=taxonomy-label>Finops</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/github/ data-taxonomy-term=github><span class=taxonomy-label>Github</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/githubactions/ data-taxonomy-term=githubactions><span class=taxonomy-label>Githubactions</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/gitops/ data-taxonomy-term=gitops><span class=taxonomy-label>Gitops</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/gke/ data-taxonomy-term=gke><span class=taxonomy-label>Gke</span><span class=taxonomy-count>38</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/grafana/ data-taxonomy-term=grafana><span class=taxonomy-label>Grafana</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/jenkins-x/ data-taxonomy-term=jenkins-x><span class=taxonomy-label>Jenkins-X</span><span class=taxonomy-count>50</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/k3s/ data-taxonomy-term=k3s><span class=taxonomy-label>K3s</span><span class=taxonomy-count>13</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/karmada/ data-taxonomy-term=karmada><span class=taxonomy-label>Karmada</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/kodekloud/ data-taxonomy-term=kodekloud><span class=taxonomy-label>Kodekloud</span><span class=taxonomy-count>15</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/kubeflow/ data-taxonomy-term=kubeflow><span class=taxonomy-label>Kubeflow</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>Kubernetes</span><span class=taxonomy-count>286</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/networking/ data-taxonomy-term=networking><span class=taxonomy-label>Networking</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/nirmata/ data-taxonomy-term=nirmata><span class=taxonomy-label>Nirmata</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/openshift/ data-taxonomy-term=openshift><span class=taxonomy-label>Openshift</span><span class=taxonomy-count>16</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/opensource/ data-taxonomy-term=opensource><span class=taxonomy-label>Opensource</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/productivity/ data-taxonomy-term=productivity><span class=taxonomy-label>Productivity</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/programming/ data-taxonomy-term=programming><span class=taxonomy-label>Programming</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/rancher/ data-taxonomy-term=rancher><span class=taxonomy-label>Rancher</span><span class=taxonomy-count>19</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/rke/ data-taxonomy-term=rke><span class=taxonomy-label>Rke</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/rke2/ data-taxonomy-term=rke2><span class=taxonomy-label>Rke2</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/rss/ data-taxonomy-term=rss><span class=taxonomy-label>Rss</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/security/ data-taxonomy-term=security><span class=taxonomy-label>Security</span><span class=taxonomy-count>17</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/servicemesh/ data-taxonomy-term=servicemesh><span class=taxonomy-label>Servicemesh</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/terraform/ data-taxonomy-term=terraform><span class=taxonomy-label>Terraform</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/terragrunt/ data-taxonomy-term=terragrunt><span class=taxonomy-label>Terragrunt</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/tigera/ data-taxonomy-term=tigera><span class=taxonomy-label>Tigera</span><span class=taxonomy-count>17</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/trivy/ data-taxonomy-term=trivy><span class=taxonomy-label>Trivy</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/vmware/ data-taxonomy-term=vmware><span class=taxonomy-label>Vmware</span><span class=taxonomy-count>16</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/blog/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>🚀 Building a Kubernetes Operator with an NGINX CRD</li></ol></nav><div class=td-content><h1>🚀 Building a Kubernetes Operator with an NGINX CRD</h1><div class=lead>Kubernetes is a powerful platform that automates the deployment, scaling, and management of&mldr;</div><div class="td-byline mb-4"><time datetime=2024-08-29 class=text-body-secondary>Thursday, August 29, 2024</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://kubermates.org/tags/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>Kubernetes</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/cloud/ data-taxonomy-term=cloud><span class=taxonomy-label>Cloud</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/containers/ data-taxonomy-term=containers><span class=taxonomy-label>Containers</span></a></li><li><a class=taxonomy-term href=https://kubermates.org/tags/opensource/ data-taxonomy-term=opensource><span class=taxonomy-label>Opensource</span></a></li></ul></div></header><p>Kubernetes is a powerful platform that automates the deployment, scaling, and management of containerized applications. One of the coolest features of Kubernetes is its ability to be extended with <strong>Custom Resource Definitions (CRDs)</strong> and <strong>Operators</strong>. In this guide, we&rsquo;ll build a simple Kubernetes operator using an NGINX CRD to manage NGINX instances in your cluster.</p><h3 id=-understanding-kubernetes-controllers-operators-and-crds>🤖 Understanding Kubernetes Controllers, Operators, and CRDs</h3><h4 id=what-is-a-kubernetes-controller>What is a Kubernetes Controller?</h4><p>A Kubernetes controller is like a robot 🤖 that continuously monitors your cluster. It checks whether the actual state of the resources matches the desired state (what you want) and makes adjustments to align them.</p><p><strong>Kubernetes Operators</strong> take this a step further. They use CRDs to define new resource types and handle the entire lifecycle of complex applications.</p><h4 id=what-is-a-custom-resource-definition-crd>What is a Custom Resource Definition (CRD)?</h4><p>A CRD allows you to define your own custom resources in Kubernetes. For instance, you can create an <code>Nginx</code> resource that specifies how you want NGINX to be deployed, and an operator will manage these resources for you.</p><h3 id=-core-components-manager-scheme-and-kinds>🛠️ Core Components: Manager, Scheme, and Kinds</h3><p>Before we dive into the code, here’s a quick overview of some key components:</p><ul><li><strong>Manager:</strong> Handles the lifecycle of your operator&rsquo;s controllers and provides shared dependencies. 📚 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/manager>Learn more</a></li><li><strong>Scheme:</strong> Maps Kubernetes resource kinds (like <code>Pod</code> or <code>Service</code>) to their corresponding Go types. 📚 <a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime#Scheme>Learn more</a></li><li><strong>Kinds:</strong> These represent specific types of resources, such as <code>Pod</code>, <code>Deployment</code>, or in our case, <code>Nginx</code>. 📚 <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/#understanding-kubernetes-objects>Learn more</a></li></ul><h3 id=-a-simple-nginx-operator-example>🧑‍💻 A Simple NGINX Operator Example</h3><p>Let’s build a Kubernetes operator that uses an <code>Nginx</code> CRD to manage NGINX instances.</p><h4 id=step-1-define-the-nginx-crd>Step 1: Define the Nginx CRD</h4><p>First, define the custom resource. This CRD tells Kubernetes how to understand our custom <code>Nginx</code> objects.</p><p>Create a file named <code>nginx_crd.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginxes.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>served</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>openAPIV3Schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>replicas</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>integer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>nginxes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>singular</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shortNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ng</span><span class=w>
</span></span></span></code></pre></div><p>Apply this CRD to your cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f nginx_crd.yaml
</span></span></code></pre></div><h4 id=step-2-import-required-packages>Step 2: Import Required Packages</h4><p>Now let’s write the Go code for our operator. Start by importing the necessary packages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os/signal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;syscall&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>corev1</span><span class=w> </span><span class=s>&#34;k8s.io/api/core/v1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=w> </span><span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;k8s.io/client-go/kubernetes/scheme&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;k8s.io/client-go/rest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/controller&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/manager&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/runtime/signals&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/source&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/handler&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/client/config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Define the Nginx type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Nginx</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=w>   </span><span class=s>`json:&#34;,inline&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=w> </span><span class=s>`json:&#34;metadata,omitempty&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Spec</span><span class=w> </span><span class=nx>NginxSpec</span><span class=w> </span><span class=s>`json:&#34;spec,omitempty&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>NginxSpec</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Replicas</span><span class=w> </span><span class=kt>int</span><span class=w>    </span><span class=s>`json:&#34;replicas&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Image</span><span class=w>    </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;image&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Define the NginxList type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>NginxList</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=w> </span><span class=s>`json:&#34;,inline&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ListMeta</span><span class=w> </span><span class=s>`json:&#34;metadata,omitempty&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Items</span><span class=w>       </span><span class=p>[]</span><span class=nx>Nginx</span><span class=w> </span><span class=s>`json:&#34;items&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=step-3-initialize-the-manager-and-register-the-crd>Step 3: Initialize the Manager and Register the CRD</h4><p>Next, create and initialize a <code>manager</code>, and register the custom <code>Nginx</code> resource with the manager&rsquo;s scheme.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Create a new Kubernetes client config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>cfg</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nf>GetConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Error creating config: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Create a new manager to provide shared dependencies and start components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mgr</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>manager</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>cfg</span><span class=p>,</span><span class=w> </span><span class=nx>manager</span><span class=p>.</span><span class=nx>Options</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Error creating manager: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Register the Nginx type with the manager&#39;s scheme</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>addSchemes</span><span class=p>(</span><span class=nx>mgr</span><span class=p>.</span><span class=nf>GetScheme</span><span class=p>());</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Error adding schemes: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Set up the controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>mgr</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Error setting up controller: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Start the manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>mgr</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>signals</span><span class=p>.</span><span class=nf>SetupSignalHandler</span><span class=p>());</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Error starting manager: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>addSchemes</span><span class=p>(</span><span class=nx>scheme</span><span class=w> </span><span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gvk</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersion</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span><span class=w> </span><span class=s>&#34;example.com&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>Version</span><span class=p>:</span><span class=w> </span><span class=s>&#34;v1&#34;</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>scheme</span><span class=p>.</span><span class=nf>AddKnownTypes</span><span class=p>(</span><span class=nx>gvk</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Nginx</span><span class=p>{},</span><span class=w> </span><span class=o>&amp;</span><span class=nx>NginxList</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=p>.</span><span class=nf>AddToGroupVersion</span><span class=p>(</span><span class=nx>scheme</span><span class=p>,</span><span class=w> </span><span class=nx>gvk</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=step-4-create-the-reconcile-logic>Step 4: Create the Reconcile Logic</h4><p>Now we define the reconciliation logic. This logic ensures that for each <code>Nginx</code> custom resource, a corresponding NGINX pod is created and maintained.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ReconcileNginx</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>client</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ReconcileNginx</span><span class=p>)</span><span class=w> </span><span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Fetch the Nginx instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>nginx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Nginx</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span><span class=w> </span><span class=nx>nginx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Nginx resource not found. Ignoring since it must have been deleted.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Error reading the object - requeue the request.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Define the desired Nginx Pod object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>pod</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>nginx</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;-pod&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodSpec</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>Containers</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>Name</span><span class=p>:</span><span class=w>  </span><span class=s>&#34;nginx&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nx>Image</span><span class=p>:</span><span class=w> </span><span class=nx>nginx</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Check if the Pod already exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>found</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span><span class=w> </span><span class=nx>found</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Creating a new NGINX Pod %s/%s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>pod</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=step-5-set-up-the-controller>Step 5: Set Up the Controller</h4><p>Finally, we set up the controller that will use the <code>ReconcileNginx</code> struct to manage NGINX instances based on the <code>Nginx</code> custom resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>mgr</span><span class=w> </span><span class=nx>manager</span><span class=p>.</span><span class=nx>Manager</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ReconcileNginx</span><span class=p>{</span><span class=nx>client</span><span class=p>:</span><span class=w> </span><span class=nx>mgr</span><span class=p>.</span><span class=nf>GetClient</span><span class=p>()}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Create a new controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>controller</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;nginx-controller&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>mgr</span><span class=p>,</span><span class=w> </span><span class=nx>controller</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span><span class=nx>Reconciler</span><span class=p>:</span><span class=w> </span><span class=nx>r</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Watch for changes to Nginx custom resources</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>Watch</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>source</span><span class=p>.</span><span class=nx>Kind</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Nginx</span><span class=p>{}},</span><span class=w> </span><span class=o>&amp;</span><span class=nx>handler</span><span class=p>.</span><span class=nx>EnqueueRequestForObject</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=-object-lifecycle-and-garbage-collection>🔄 Object Lifecycle and Garbage Collection</h3><p>One of the critical aspects of Kubernetes is how it handles the lifecycle of objects, ensuring that resources are created, updated, and deleted according to the desired state specified by the user or an operator.</p><h4 id=object-lifecycle>Object Lifecycle</h4><p>In Kubernetes, every resource has a lifecycle, including creation, updates, and deletion:</p><ul><li><strong>Creation</strong>: When a new custom resource like <code>Nginx</code> is created, the operator’s controller is triggered to reconcile the resource by creating the corresponding NGINX pod.</li><li><strong>Updates</strong>: If the <code>Nginx</code> resource is updated (e.g., changing the image or replica count), the controller detects this and updates the corresponding resources to match the desired state.</li><li><strong>Deletion</strong>: When a custom resource is deleted, Kubernetes expects that the associated resources (like pods) will be cleaned up to prevent orphaned resources.</li></ul><h4 id=garbage-collection-in-controller-runtime>Garbage Collection in Controller Runtime</h4><p>Controller-runtime, the library we use in this example, provides built-in support for managing the lifecycle of resources and performing garbage collection:</p><ul><li><p><strong>OwnerReferences</strong>: One of the key features is the use of <code>OwnerReferences</code>. When a controller creates a resource (like a pod), it sets the custom resource (like <code>Nginx</code>) as the owner of the pod. This means that if the <code>Nginx</code> resource is deleted, Kubernetes automatically deletes the associated pod, ensuring that resources do not get orphaned.</p></li><li><p><strong>Finalizers</strong>: Finalizers are another mechanism to ensure that cleanup tasks are completed before a resource is fully deleted. For example, you can add a finalizer to the <code>Nginx</code> resource that ensures the associated pod is deleted before the <code>Nginx</code> resource itself is removed.</p></li></ul><p>This automatic garbage collection helps keep your cluster clean and prevents resource leaks, making your operators more robust and reliable.</p><h3 id=-building-and-deploying-the-operator>🚢 Building and Deploying the Operator</h3><p>Now that the code is ready, let’s build and deploy your operator to the Kubernetes cluster.</p><h4 id=step-1-build-the-operator>Step 1: Build the Operator</h4><ol><li><p>Create a <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>golang:1.23</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s>builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/workspace</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> <span class=nv>GOOS</span><span class=o>=</span>linux <span class=nv>GOARCH</span><span class=o>=</span>amd64 go build -a -o nginx-operator main.go<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>alpine:3.20</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>WORKDIR /<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /workspace/nginx-operator .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/nginx-operator&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div></li><li><p>Build and push the Docker image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t your-docker-repo/nginx-operator:v1 .
</span></span><span class=line><span class=cl>docker push your-docker-repo/nginx-operator:v1
</span></span></code></pre></div></li></ol><h4 id=step-2-deploy-the-operator>Step 2: Deploy the Operator</h4><p>Create a Kubernetes deployment to run your operator:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-operator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-operator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-operator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-operator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>your-docker-repo/nginx-operator:v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span></code></pre></div><p>Apply the deployment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml
</span></span></code></pre></div><h3 id=-creating-an-nginx-custom-resource>🧑‍🏭 Creating an Nginx Custom Resource</h3><p>Now, let’s create an <code>Nginx</code> custom resource to deploy an NGINX instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>example.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:latest</span><span class=w>
</span></span></span></code></pre></div><p>Apply this resource:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f my_nginx.yaml
</span></span></code></pre></div><p>Your operator will detect this custom resource and automatically create an NGINX pod in your cluster!</p><h3 id=-conclusion>🎉 Conclusion</h3><p>In this guide, we’ve walked through creating a Kubernetes operator using a Custom Resource Definition (CRD) to manage NGINX instances. You’ve learned how to define a CRD, implement a custom controller, and deploy it to a Kubernetes cluster.</p><p>We also discussed the lifecycle of objects in Kubernetes and how controller-runtime handles garbage collection automatically, ensuring that resources are managed efficiently and without leaving orphaned resources.</p><p>While this example gives you a solid foundation, in real-world scenarios, you’ll likely want to use tools like <strong>Kubebuilder</strong> or <strong>Operator SDK</strong>. These tools greatly simplify the development of Kubernetes operators by providing scaffolding, code generation, and built-in best practices, allowing you to focus more on the business logic of your operators rather than the boilerplate code.</p><p>For more advanced operator development, check out:</p><ul><li><a href=https://kubebuilder.io/>Kubebuilder</a></li><li><a href=https://sdk.operatorframework.io/>Operator SDK</a></li></ul><p>Happy clustering! 🚀</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/hacking-the-helm-operator-with-flux-creating-self-installable-services-for-easier-app-deployment-5a8l/ aria-label="Previous - 🎨 Hacking the Helm Operator with Flux: Creating Self-Installable Services for Easier App Deployment" class="btn btn-primary"><span class=me-1>←</span>Previous</a></li><li><a href=/blog/insights-on-securing-your-kubernetes-cluster-with-falco-4b9g/ aria-label="Next - Insights on Securing Your Kubernetes Cluster with Falco 🚀🔒" class="btn btn-primary">Next<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class=km-footer role=contentinfo><style>.km-footer{background:#0a2540;color:#fff;padding:15px 0;margin:0;width:100vw;margin-left:calc(50% - 50vw);margin-right:calc(50% - 50vw);border:0;outline:0;padding-left:0;padding-right:0}.km-footer a{color:#00d1b2;text-decoration:none}.km-footer .km-social{display:flex;justify-content:center;gap:20px;margin-top:8px}.km-footer .km-social a{color:#00d1b2!important;font-size:28px;line-height:1;transition:color .2s ease}.km-footer .km-social a:hover{color:#10b981!important}html,body{overflow-x:hidden}</style><div class=text-center><p class=mb-1 style=margin:0>© 2025 Kubermates powered by
<a href=https://kapheira.cloud>Kapheira</a> and
<a href=https://www.linkedin.com/in/hamdi-khelil/ rel=author>Hamdi KHELIL</a>.</p><div class=km-social><a href=https://github.com/kubermates-org target=_blank rel=noopener aria-label=GitHub><i class="fab fa-github" aria-hidden=true></i>
</a><a href=https://www.linkedin.com/company/kubermates target=_blank rel=noopener aria-label=LinkedIn><i class="fab fa-linkedin" aria-hidden=true></i>
</a><a href=https://www.youtube.com/@Kubermates target=_blank rel=noopener aria-label=YouTube><i class="fab fa-youtube" aria-hidden=true></i>
</a><a href=https://kubermates.slack.com target=_blank rel=noopener aria-label=Slack><i class="fab fa-slack" aria-hidden=true></i></a></div></div></footer></div><script src=/js/main.min.d844e8cb3c2d74f005336b0c873045728e53ff0ce5534c7d8563fa0676a87b08.js integrity="sha256-2EToyzwtdPAFM2sMhzBFco5T/wzlU0x9hWP6Bnaoewg=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>