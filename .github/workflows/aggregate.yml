name: Aggregate content

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  aggregate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        working-directory: scripts/ingest
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run ingesters
        run: |
          python scripts/ingest/ingest_docs.py
          python scripts/ingest/ingest_releases.py
          python scripts/ingest/ingest_rss_events.py
          python scripts/ingest/ingest_cncf_events.py

      - name: Remove pycache noise
        run: |
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
          find . -type f \( -name '*.pyc' -o -name '*.pyo' -o -name '*.pyd' \) -delete || true

      - name: Make branch name
        id: vars
        run: |
          echo "branch=bot/ingest-$(TZ=Europe/Paris date +%Y-%m-%d-%H)h-$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          base: main
          branch: ${{ steps.vars.outputs.branch }}
          title: "chore: ingest update aggregated content"
          commit-message: "chore: ingest update aggregated content"
          body: Automated content aggregation
          delete-branch: true
          add-paths: |
            content/**
            scripts/ingest/state.json
          labels: automerge
